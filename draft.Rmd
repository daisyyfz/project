---
title: "Draft"
author: "Daisy Fang"
date: "2/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r load-packages}
library(tidyverse)
library(lubridate)
```

```{r load-data}
all_pallets <- read_csv("all_pallets.csv")
```

```{r clean-data}
# item_category
all_pallets <- all_pallets %>% 
  mutate(item_category = case_when(str_detect(item_desc, "MASHED|MASH|MSHD|SR CRM & CHIVE POTAS") ~ "MASHED POTATO",
                                   str_detect(item_desc, "POT|WEDGE") ~ "OTHER POTATO",
                                   str_detect(item_desc, "MACARONI|MAC") ~ "MAC & CHEESE",
                                   str_detect(item_desc, "LINKS|LINK|LIN|PROLL|ROLL|PATTIES|PATTIS|PAT|PTY|PORK SAUS") ~ "SAUSAGE",
                                   TRUE ~ "OTHERS"))
# proportion check
all_pallets %>% 
  count(item_category) %>% 
  summarize(item_category, n, prop = n/sum(n))

# # check counts to create categories
# all_pallets %>% 
#   filter(item_category == "OTHERS") %>% 
#   filter(!str_detect(item_desc, "LINKS|LINK|LIN|PROLL|ROLL|PATTIES|PATTIS|PAT|PTY|PORK SAUS")) %>% 
#   count(item_desc) %>% 
#   arrange(desc(n))
```



```{r time-series, eval=FALSE}
test_cnt <- sausage %>% 
  mutate(week = week(date_out),
         month = month(date_out),
         year = as.factor(year(date_out))) %>% 
  group_by(year, week) %>% 
  count() %>% 
  filter(year == 2020)

# one week autocorrelation
acf(test_cnt$n)
```

### get mashed potato data

```{r}
mashedpotato <- all_pallets %>% 
  filter(item_category == "MASHED POTATO") %>% 
  filter(orig_qty == qty_picked) %>% 
  select(item_category, date_in, latest_date) %>% 
  mutate(date_in = date(date_in),
         #year_week_in = paste(year(date_in), " W", week(date_in), sep = ""),
         date_out = date(latest_date),
         #year_week_out = paste(year(date_out), " W", week(date_out), sep = "")
         ) %>% 
  select(-latest_date) %>% 
  group_by(date_out) %>% 
  count() %>% 
  mutate(week = week(date_out),
         month = month(date_out),
         year = as.factor(year(date_out))) %>% 
  filter(week != 53)

mashedpotato

```


### Goal 1: difference during COVID
```{r t-tests}
n19 <- mashedpotato %>% 
  filter(month == 3, year == 2019) %>% 
  select(n, year)

n19 <- n19$n

n20 <- mashedpotato %>% 
  filter(month == 3, year == 2020) %>% 
  select(n, year)

n20 <- n20$n

t.test(n19, n20)

diff <- n20-n19

plot.ts(diff)



# Wilcox test
wilcox.test(n19, n20, paired = TRUE)

```

### Goal 2: general seasonality
```{r decomposition}
test_week <- mashedpotato %>% 
  group_by(year, week) %>% 
  summarize(n = sum(n))

test_month <- mashedpotato %>% 
  group_by(year, month) %>% 
  summarize(n = sum(n))

# 2019-2020 by day
plot.ts(mashedpotato$n)
# 2019-2020 by week
plot.ts(test_week$n)
# 2019-2020 by month
plot.ts(test_month$n)

# additive decomposition
# https://rstudio-pubs-static.s3.amazonaws.com/84226_ad792383c050483bbae4676bc76a4038.html
test_week <- ts(test_week$n, frequency = 52)
test_week_decomp <- decompose(test_week)
plot(test_week_decomp)
# minus seasonality
plot(test_week - test_week_decomp$seasonal)

# additive decomposition
test_day <- ts(mashedpotato$n, frequency = 361)
test_day_decomp <- decompose(test_day)
plot(test_day_decomp)
# minus seasonality

```

### Goal 3: future demand



